<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circle Skirt Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: manipulation;
        }
        
        body {
            background: #f0f2f5;
            color: #333;
            padding: 12px;
            min-height: 100vh;
        }
        
        .calculator-container {
            max-width: 1100px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 12px;
            align-items: stretch;
        }
        
        .input-section, .visual-section {
            background: white;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            height: auto;
            display: flex;
            flex-direction: column;
        }
        
        .visual-section {
            align-items: center;
            justify-content: flex-start;
            position: relative;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 18px; 
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
            width: 100%;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 8px;
        }
        
        label {
            display: block;
            margin-bottom: 2px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 14px;
        }
        
        .input-with-slider {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .number-input {
            width: 100%;
            padding: 3px 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
            height: 28px;
        }
        
        .number-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 6px;
            width: 100%;
            height: 40px;
        }

        .dot-selector-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 5px;
        }

        .dot-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            flex: 1;
            -webkit-tap-highlight-color: transparent;
        }

        .dot {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 3px solid #3498db;
            background: white;
            margin-bottom: 6px;
            transition: all 0.2s;
        }

        .dot-option.active .dot {
            background: #3498db;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.6);
        }

        .dot-label {
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
            white-space: nowrap;
        }
        
        .slider-value {
            min-width: 28px;
            font-size: 13px;
            color: #666;
            text-align: right;
        }
        
        .range-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: #3498db;
            border-radius: 2px;
            outline: none;
            margin: 0;
        }
        
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .range-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .canvas-container {
            width: 100%;
            height: auto;
            flex-grow: 1;
            min-height: 640px; 
            position: relative;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
        }
        
        canvas {
            width: 100%;
            height: 100%;
        }
        
        .panel-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px; 
            margin-top: 8px; 
            width: 100%;
        }
        
        .panel-btn {
            padding: 8px 5px; 
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px; 
            font-weight: 600;
            -webkit-tap-highlight-color: transparent;
        }
        
        .panel-btn:hover { background: #2980b9; }
        .panel-btn.secondary { background: #e67e22; }
        .panel-btn.secondary:hover { background: #d35400; }
        .panel-btn.undo { background: #7f8c8d; }
        .panel-btn.undo:hover { background: #636e72; }
        .panel-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 12px 0;
        }
        
        .results-box {
            background: #f8f9fa;
            border-radius: 3px;
            padding: 12px;
        }
        
        .measurements-box {
            background: #f8f9fa;
            border-radius: 3px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .result-item {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .result-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .result-value {
            font-size: 22px; 
            font-weight: 600;
            color: #2c3e50;
        }
        
        .panel-measurements {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
            font-size: 11px;
            max-width: 180px;
            max-height: 200px;
            overflow-y: auto;
            display: none; /* Hidden since we moved it to the input section */
        }
        
        .measurements-header {
            font-size: 12px;
            margin-bottom: 6px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 3px;
        }
        
        .panel-measurement-item {
            margin-bottom: 3px;
            display: flex;
            justify-content: space-between;
        }
        
        .panel-number {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .measurement-value {
            font-weight: 600;
            color: #e74c3c;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 500;
            font-size: 20px; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .reset-btn { background: #95a5a6; color: white; }
        .reset-btn:hover { background: #7f8c8d; }
        .preview-btn { background: #2ecc71; color: white; }
        .preview-btn:hover { background: #27ae60; }

        .drag-handle {
            display: none;
            width: 40px;
            height: 6px;
            background: #ccc;
            border-radius: 3px;
            margin: 4px auto 10px auto;
        }
        
        @media (max-width: 768px) {
            body { padding: 0; overflow-x: hidden; }
            .calculator-container { grid-template-columns: 1fr; gap: 0; }
            
            .drag-handle { display: block; }

            .visual-section { 
                margin-bottom: 0; 
                padding: 4px 0 12px 0;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
                border-radius: 0 0 15px 15px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                width: 100vw;
                transition: transform 0.1s ease-out;
                touch-action: none; 
            }
            
            .visual-section h2 { padding-left: 12px; margin-bottom: 8px; cursor: ns-resize; }
            
            .form-row { grid-template-columns: 1fr; }
            .canvas-container { 
                min-height: 300px; 
                max-height: 50vh;
                border-left: none; 
                border-right: none; 
                border-radius: 0;
            } 
            
            .panel-controls { 
                margin-top: 8px; 
                gap: 6px; 
                padding: 0 12px;
            }
            .panel-btn { 
                font-size: 15px;
                padding: 10px 5px;
            }
            
            .input-section { 
                margin-top: 520px; 
                padding: 12px; 
                border-radius: 0; 
                position: relative;
                z-index: 1;
            }
            
            /* Increased dimension for Full and 3/4 circle buttons on mobile */
            .dot-option[data-type="full"] .dot, 
            .dot-option[data-type="three-quarter"] .dot { 
                width: 58px; 
                height: 58px; 
            }
            .dot { width: 44px; height: 44px; }

            .input-with-slider {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }
            .number-input {
                width: 70px; 
                flex-shrink: 0;
            }
            .slider-container {
                flex-grow: 1;
                height: 30px;
            }
            
            .results-container {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .canvas-container {
                min-height: 280px;
            }
            
            .dot-option[data-type="full"] .dot, 
            .dot-option[data-type="three-quarter"] .dot { 
                width: 48px; 
                height: 48px; 
            }
            .dot { width: 36px; height: 36px; }
            
            .dot-label {
                font-size: 10px;
            }
        }
        
        /* PDF print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .pdf-container, .pdf-container * {
                visibility: visible;
            }
            .pdf-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <div class="visual-section" id="floatingCircle">
            <div class="drag-handle"></div>
            <h2 id="dragZone">Pattern Preview</h2>
            <div class="canvas-container" id="container">
                <canvas id="skirtCanvas"></canvas>
            </div>
            <div class="panel-controls">
                <button class="panel-btn secondary" id="splitSingle">Split Selected</button>
                <button class="panel-btn secondary" id="mergeSingle">Merge Selected</button>
                <button class="panel-btn undo" id="undoAction" disabled>Undo</button>
                <button class="panel-btn" id="splitAll">Split All</button>
                <button class="panel-btn" id="mergeAll">Merge All</button>
                <button class="panel-btn" id="resetPanels">Reset</button>
            </div>
        </div>
        
        <div class="input-section" id="settingsSection">
            <h2>Skirt Settings</h2>
            
            <div class="form-group">
                <div class="dot-selector-container">
                    <div class="dot-option" data-type="full">
                        <div class="dot"></div>
                        <span class="dot-label">Full</span>
                    </div>
                    <div class="dot-option" data-type="three-quarter">
                        <div class="dot"></div>
                        <span class="dot-label">3/4</span>
                    </div>
                    <div class="dot-option" data-type="half">
                        <div class="dot"></div>
                        <span class="dot-label">Half</span>
                    </div>
                    <div class="dot-option" data-type="third">
                        <div class="dot"></div>
                        <span class="dot-label">1/3</span>
                    </div>
                    <div class="dot-option" data-type="quarter">
                        <div class="dot"></div>
                        <span class="dot-label">1/4</span>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div>
                    <div class="form-group">
                        <label>Total Seams:</label>
                        <div class="input-with-slider">
                            <input type="number" class="number-input" id="seams" value="12" min="1" max="100" step="1">
                            <div class="slider-container">
                                <input type="range" class="range-slider" id="seamsSlider" min="1" max="32" step="1" value="12">
                                <span class="slider-value" id="seamsValue">12</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Side Seam:</label>
                        <div class="input-with-slider">
                            <input type="number" class="number-input" id="sideSeam" value="0.375" min="0" max="2" step="0.125">
                            <div class="slider-container">
                                <input type="range" class="range-slider" id="sideSeamSlider" min="0" max="2" step="0.125" value="0.375">
                                <span class="slider-value" id="sideSeamValue">0.375</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Length:</label>
                        <div class="input-with-slider">
                            <input type="number" class="number-input" id="length" value="22" min="5" max="60" step="0.5">
                            <div class="slider-container">
                                <input type="range" class="range-slider" id="lengthSlider" min="5" max="60" step="0.5" value="22">
                                <span class="slider-value" id="lengthValue">22</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="form-group">
                        <label>Waist Circ.:</label>
                        <div class="input-with-slider">
                            <input type="number" class="number-input" id="waist" value="38.5" min="20" max="60" step="0.5">
                            <div class="slider-container">
                                <input type="range" class="range-slider" id="waistSlider" min="20" max="60" step="0.5" value="38.5">
                                <span class="slider-value" id="waistValue">38.5</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Waist Seam:</label>
                        <div class="input-with-slider">
                            <input type="number" class="number-input" id="waistSeam" value="0.375" min="0" max="2" step="0.125">
                            <div class="slider-container">
                                <input type="range" class="range-slider" id="waistSeamSlider" min="0" max="2" step="0.125" value="0.375">
                                <span class="slider-value" id="waistSeamValue">0.375</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Hem Allowance:</label>
                        <div class="input-with-slider">
                            <input type="number" class="number-input" id="hem" value="1.5" min="0" max="3" step="0.125">
                            <div class="slider-container">
                                <input type="range" class="range-slider" id="hemSlider" min="0" max="3" step="0.125" value="1.5">
                                <span class="slider-value" id="hemValue">1.5</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <h2>Results</h2>
            <div class="results-container">
                <div class="results-box">
                    <div class="result-item">
                        <div class="result-label">Waist Radius</div>
                        <div class="result-value" id="waistRadius">6.25"</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Total Radius</div>
                        <div class="result-value" id="totalRadius">29.75"</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Total Waist Arc</div>
                        <div class="result-value" id="waistArc">43.75"</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Total Hem Arc</div>
                        <div class="result-value" id="totalHemArc">187.07"</div>
                    </div>
                </div>
                
                <div class="measurements-box" id="measurementsBox">
                    <div class="measurements-header">Panel Measurements</div>
                    <div id="measurementsList"></div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn reset-btn" id="resetBtn">RESET</button>
                <button class="action-btn preview-btn" id="previewBtn">DOWNLOAD PDF</button>
            </div>
        </div>
    </div>

    <script>
        class CircleSkirtCalculator {
            constructor() {
                this.history = [];
                this.selectedIndex = null;
                this.secondSelectedIndex = null;
                this.panelMeasurements = [];
                this.initElements();
                this.initCanvas();
                this.bindEvents();
                this.setupSliders();
                this.setupMobileSlide();
                this.calculate();
            }
            
            initElements() {
                this.dotOptions = document.querySelectorAll('.dot-option');
                this.skirtType = 'full';
                this.seamsInput = document.getElementById('seams');
                this.sideSeamInput = document.getElementById('sideSeam');
                this.lengthInput = document.getElementById('length');
                this.waistInput = document.getElementById('waist');
                this.waistSeamInput = document.getElementById('waistSeam');
                this.hemInput = document.getElementById('hem');
                this.seamsValue = document.getElementById('seamsValue');
                this.sideSeamValue = document.getElementById('sideSeamValue');
                this.lengthValue = document.getElementById('lengthValue');
                this.waistValue = document.getElementById('waistValue');
                this.waistSeamValue = document.getElementById('waistSeamValue');
                this.hemValue = document.getElementById('hemValue');
                this.waistRadiusEl = document.getElementById('waistRadius');
                this.totalRadiusEl = document.getElementById('totalRadius');
                this.waistArcEl = document.getElementById('waistArc');
                this.totalHemArcEl = document.getElementById('totalHemArc');
                this.resetBtn = document.getElementById('resetBtn');
                this.resetPanelsBtn = document.getElementById('resetPanels');
                this.undoBtn = document.getElementById('undoAction');
                this.canvas = document.getElementById('skirtCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.panels = [];
                this.seams = 12;
                this.customPanels = null; 
                this.setSkirtType('full');
            }
            
            setSkirtType(type) {
                this.skirtType = type;
                this.customPanels = null;
                this.dotOptions.forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.type === type);
                });
            }
            
            initCanvas() {
                const rect = this.canvas.parentNode.getBoundingClientRect();
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;
            }

            setupSliders() {
                const configs = [
                    { input: 'seams', slider: 'seamsSlider', val: 'seamsValue' },
                    { input: 'sideSeam', slider: 'sideSeamSlider', val: 'sideSeamValue' },
                    { input: 'length', slider: 'lengthSlider', val: 'lengthValue' },
                    { input: 'waist', slider: 'waistSlider', val: 'waistValue' },
                    { input: 'waistSeam', slider: 'waistSeamSlider', val: 'waistSeamValue' },
                    { input: 'hem', slider: 'hemSlider', val: 'hemValue' }
                ];

                configs.forEach(config => {
                    const i = document.getElementById(config.input);
                    const s = document.getElementById(config.slider);
                    const v = document.getElementById(config.val);

                    i.addEventListener('input', () => { 
                        s.value = i.value; 
                        v.textContent = i.value; 
                        if(config.input === 'seams') {
                            this.seams = parseInt(i.value);
                            this.customPanels = null;
                        }
                        this.calculate(); 
                    });
                    s.addEventListener('input', () => { 
                        i.value = s.value; 
                        v.textContent = s.value; 
                        if(config.input === 'seams') {
                            this.seams = parseInt(s.value);
                            this.customPanels = null;
                        }
                        this.calculate(); 
                    });
                });
            }

            setupMobileSlide() {
                const floating = document.getElementById('floatingCircle');
                const dragZone = document.getElementById('dragZone');
                const handle = document.querySelector('.drag-handle');
                const settings = document.getElementById('settingsSection');
                
                let startY = 0;
                let currentTranslateY = 0;
                let isDragging = false;

                const onStart = (e) => {
                    if (window.innerWidth > 768) return;
                    startY = e.touches ? e.touches[0].clientY : e.clientY;
                    isDragging = true;
                    floating.style.transition = 'none';
                };

                const onMove = (e) => {
                    if (!isDragging) return;
                    const y = e.touches ? e.touches[0].clientY : e.clientY;
                    const deltaY = y - startY;
                    
                    let newY = currentTranslateY + deltaY;
                    if (newY > 0) newY = 0; 
                    if (newY < -350) newY = -350; 

                    floating.style.transform = `translateY(${newY}px)`;
                };

                const onEnd = () => {
                    if (!isDragging) return;
                    isDragging = false;
                    floating.style.transition = 'transform 0.3s ease-out';
                    
                    const style = window.getComputedStyle(floating);
                    const matrix = new WebKitCSSMatrix(style.transform);
                    currentTranslateY = matrix.m42;
                };

                [dragZone, handle].forEach(el => {
                    el.addEventListener('touchstart', onStart);
                    el.addEventListener('mousedown', onStart);
                });

                window.addEventListener('mousemove', onMove);
                window.addEventListener('touchmove', onMove, { passive: false });
                window.addEventListener('mouseup', onEnd);
                window.addEventListener('touchend', onEnd);

                const updateOffset = () => {
                    if (window.innerWidth <= 768) {
                        settings.style.marginTop = (floating.offsetHeight + 10) + 'px';
                    } else {
                        settings.style.marginTop = '0';
                        floating.style.transform = 'none';
                    }
                };
                window.addEventListener('resize', updateOffset);
                setTimeout(updateOffset, 100);
            }

            saveState() {
                const state = {
                    customPanels: this.customPanels ? JSON.parse(JSON.stringify(this.customPanels)) : null,
                    seams: this.seams,
                    skirtType: this.skirtType
                };
                this.history.push(state);
                this.updateUndoButton();
            }

            undo() {
                if (this.history.length > 0) {
                    const lastState = this.history.pop();
                    this.customPanels = lastState.customPanels;
                    this.seams = lastState.seams;
                    this.skirtType = lastState.skirtType;
                    this.seamsInput.value = this.seams;
                    this.seamsValue.textContent = this.seams;
                    document.getElementById('seamsSlider').value = this.seams;
                    this.setSkirtType(this.skirtType);
                    this.selectedIndex = null;
                    this.secondSelectedIndex = null;
                    this.calculate();
                    this.updateUndoButton();
                }
            }

            updateUndoButton() {
                this.undoBtn.disabled = this.history.length === 0;
            }

            updateSeamCount(val) {
                this.seams = val;
                this.seamsInput.value = val;
                this.seamsValue.textContent = val;
                document.getElementById('seamsSlider').value = val;
                this.calculate();
            }

            getSkirtBounds(multiplier, totalRadius) {
                const points = [];
                const steps = 50;
                for (let i = 0; i <= steps; i++) {
                    const angle = (i / steps) * multiplier * Math.PI;
                    points.push({
                        x: Math.cos(angle) * totalRadius,
                        y: Math.sin(angle) * totalRadius
                    });
                }
                const minX = Math.min(...points.map(p => p.x), 0);
                const maxX = Math.max(...points.map(p => p.x), 0);
                const minY = Math.min(...points.map(p => p.y), 0);
                const maxY = Math.max(...points.map(p => p.y), 0);
                return { minX, maxX, minY, maxY, width: maxX - minX, height: maxY - minY };
            }

            calculate() {
                const waist = parseFloat(this.waistInput.value);
                const sideSeam = parseFloat(this.sideSeamInput.value);
                const length = parseFloat(this.lengthInput.value);
                const hem = parseFloat(this.hemInput.value);
                const waistSeam = parseFloat(this.waistSeamInput.value);

                let multiplier;
                switch(this.skirtType) {
                    case 'full': multiplier = 2; break;
                    case 'three-quarter': multiplier = 1.5; break;
                    case 'half': multiplier = 1; break;
                    case 'third': multiplier = 0.666; break;
                    case 'quarter': multiplier = 0.5; break;
                }

                const adjustedWaist = waist + (sideSeam * 2);
                const waistRadius = adjustedWaist / (multiplier * Math.PI);
                const totalRadius = waistRadius + length + hem;
                const waistArc = adjustedWaist + (waistSeam * 2);
                const totalHemArc = (totalRadius * multiplier * Math.PI);

                this.waistRadiusEl.textContent = waistRadius.toFixed(2) + '"';
                this.totalRadiusEl.textContent = totalRadius.toFixed(2) + '"';
                this.waistArcEl.textContent = waistArc.toFixed(2) + '"';
                this.totalHemArcEl.textContent = totalHemArc.toFixed(2) + '"';

                this.draw(multiplier, waistRadius, totalRadius, waistSeam, hem);
            }

            draw(multiplier, waistRadius, totalRadius, waistSeam, hem) {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Apply rotation for half, third, and quarter circles to better fit container
                let rotationAngle = 0;
                if (this.skirtType === 'half') {
                    rotationAngle = Math.PI / 4; // 45 degrees for half circle
                } else if (this.skirtType === 'third') {
                    rotationAngle = Math.PI / 3; // 60 degrees for 1/3 circle
                } else if (this.skirtType === 'quarter') {
                    rotationAngle = Math.PI / 4; // 45 degrees for quarter circle
                }
                
                // Calculate bounds with rotation
                const bounds = this.getRotatedBounds(multiplier, waistRadius, totalRadius, rotationAngle);
                const padding = window.innerWidth <= 768 ? 10 : 20;
                const availableWidth = this.canvas.width - padding * 2;
                const availableHeight = this.canvas.height - padding * 2;
                
                // Scale factor to fill screen - slightly boosted on mobile
                const baseScale = Math.min(availableWidth / bounds.width, availableHeight / bounds.height);
                const scale = window.innerWidth <= 768 ? baseScale * 1.1 : baseScale;
                
                // Center the drawing
                const offsetX = (this.canvas.width / 2) - ((bounds.minX + bounds.maxX) / 2 * scale);
                const offsetY = (this.canvas.height / 2) - ((bounds.minY + bounds.maxY) / 2 * scale);

                const panelCount = this.customPanels ? this.customPanels.length : this.seams;
                this.panels = [];
                this.panelMeasurements = [];

                for (let i = 0; i < panelCount; i++) {
                    let startAngle, endAngle;
                    if (this.customPanels) {
                        startAngle = this.customPanels[i].start;
                        endAngle = this.customPanels[i].end;
                    } else {
                        const panelSize = (multiplier * Math.PI) / panelCount;
                        startAngle = i * panelSize;
                        endAngle = (i + 1) * panelSize;
                    }

                    // Apply rotation
                    const rotatedStartAngle = startAngle + rotationAngle;
                    const rotatedEndAngle = endAngle + rotationAngle;

                    this.panels.push({ startAngle: rotatedStartAngle, endAngle: rotatedEndAngle });

                    // Calculate panel measurements
                    const panelAngle = endAngle - startAngle;
                    const waistArcLength = (waistRadius * panelAngle).toFixed(2);
                    const hemArcLength = (totalRadius * panelAngle).toFixed(2);
                    const sideSeamLength = (totalRadius - waistRadius).toFixed(2);
                    
                    this.panelMeasurements.push({
                        panel: i + 1,
                        waistArc: waistArcLength,
                        hemArc: hemArcLength,
                        sideSeam: sideSeamLength
                    });

                    this.ctx.beginPath();
                    this.ctx.arc(offsetX, offsetY, totalRadius * scale, rotatedStartAngle, rotatedEndAngle);
                    this.ctx.arc(offsetX, offsetY, waistRadius * scale, rotatedEndAngle, rotatedStartAngle, true);
                    this.ctx.closePath();

                    const isSelected = (this.selectedIndex === i || this.secondSelectedIndex === i);
                    this.ctx.fillStyle = isSelected ? '#3498db' : (i % 2 === 0 ? '#ecf0f1' : '#bdc3c7');
                    this.ctx.fill();
                    this.ctx.strokeStyle = isSelected ? '#2980b9' : '#7f8c8d';
                    this.ctx.lineWidth = isSelected ? 3 : 1;
                    this.ctx.stroke();

                    // Draw dotted seam allowance lines
                    this.ctx.setLineDash([3, 3]);
                    this.ctx.strokeStyle = '#e74c3c';
                    this.ctx.lineWidth = 1;
                    
                    // Waist seam allowance
                    this.ctx.beginPath();
                    this.ctx.arc(offsetX, offsetY, (waistRadius + waistSeam) * scale, rotatedStartAngle, rotatedEndAngle);
                    this.ctx.stroke();
                    
                    // Hem seam allowance
                    this.ctx.beginPath();
                    this.ctx.arc(offsetX, offsetY, (totalRadius - hem) * scale, rotatedStartAngle, rotatedEndAngle);
                    this.ctx.stroke();
                    
                    this.ctx.setLineDash([]);

                    // Draw panel number - increased 2 sizes and prefixed with "P"
                    const midAngle = (rotatedStartAngle + rotatedEndAngle) / 2;
                    const labelRadius = ((waistRadius + totalRadius) / 2) * scale;
                    const labelX = offsetX + Math.cos(midAngle) * labelRadius;
                    const labelY = offsetY + Math.sin(midAngle) * labelRadius;
                    
                    this.ctx.fillStyle = '#2c3e50';
                    this.ctx.font = 'bold 18px Arial'; // Increased from 14px to 18px
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(`P${i + 1}`, labelX, labelY); // Changed from number to P1, P2, etc.

                    // Draw waist arc measurement - increased 2 sizes from 10px to 14px
                    const waistLabelRadius = (waistRadius + waistSeam + 0.5) * scale;
                    const waistLabelX = offsetX + Math.cos(midAngle) * waistLabelRadius;
                    const waistLabelY = offsetY + Math.sin(midAngle) * waistLabelRadius;
                    
                    this.ctx.fillStyle = '#27ae60';
                    this.ctx.font = '14px Arial'; // Increased from 10px to 14px
                    this.ctx.fillText(`${waistArcLength}"`, waistLabelX, waistLabelY);

                    // Draw hem arc measurement - increased 2 sizes from 10px to 14px
                    const hemLabelRadius = (totalRadius - hem - 0.5) * scale;
                    const hemLabelX = offsetX + Math.cos(midAngle) * hemLabelRadius;
                    const hemLabelY = offsetY + Math.sin(midAngle) * hemLabelRadius;
                    
                    this.ctx.fillStyle = '#e74c3c';
                    this.ctx.font = '14px Arial'; // Increased from 10px to 14px
                    this.ctx.fillText(`${hemArcLength}"`, hemLabelX, hemLabelY);
                }

                // Update measurements list
                this.updateMeasurementsList();
            }

            getRotatedBounds(multiplier, waistRadius, totalRadius, rotationAngle) {
                const points = [];
                const steps = 100;
                
                // Sample points along the outer arc
                for (let i = 0; i <= steps; i++) {
                    const angle = (i / steps) * multiplier * Math.PI + rotationAngle;
                    points.push({
                        x: Math.cos(angle) * totalRadius,
                        y: Math.sin(angle) * totalRadius
                    });
                }
                
                // Sample points along the inner arc
                for (let i = 0; i <= steps; i++) {
                    const angle = (i / steps) * multiplier * Math.PI + rotationAngle;
                    points.push({
                        x: Math.cos(angle) * waistRadius,
                        y: Math.sin(angle) * waistRadius
                    });
                }
                
                // Add center point
                points.push({ x: 0, y: 0 });
                
                const minX = Math.min(...points.map(p => p.x));
                const maxX = Math.max(...points.map(p => p.x));
                const minY = Math.min(...points.map(p => p.y));
                const maxY = Math.max(...points.map(p => p.y));
                
                return { minX, maxX, minY, maxY, width: maxX - minX, height: maxY - minY };
            }

            updateMeasurementsList() {
                const measurementsList = document.getElementById('measurementsList');
                measurementsList.innerHTML = '';
                
                this.panelMeasurements.forEach(measurement => {
                    const div = document.createElement('div');
                    div.className = 'panel-measurement-item';
                    div.innerHTML = `
                        <span class="panel-number">Panel ${measurement.panel}:</span>
                        <span class="measurement-value">W:${measurement.waistArc}" H:${measurement.hemArc}" S:${measurement.sideSeam}"</span>
                    `;
                    measurementsList.appendChild(div);
                });
            }

            bindEvents() {
                this.dotOptions.forEach(opt => {
                    opt.addEventListener('click', () => {
                        this.saveState();
                        this.setSkirtType(opt.dataset.type);
                        this.calculate();
                    });
                });

                this.canvas.addEventListener('click', (e) => this.handleCanvasClick(e));
                
                document.getElementById('splitSingle').addEventListener('click', () => {
                    if (this.selectedIndex !== null) {
                        this.saveState();
                        this.splitPanel(this.selectedIndex);
                    }
                });

                document.getElementById('mergeSingle').addEventListener('click', () => {
                    if (this.selectedIndex !== null && this.secondSelectedIndex !== null) {
                        this.saveState();
                        this.mergePanels(this.selectedIndex, this.secondSelectedIndex);
                    }
                });

                document.getElementById('splitAll').addEventListener('click', () => {
                    this.saveState();
                    const newCount = this.customPanels ? this.customPanels.length * 2 : this.seams * 2;
                    this.customPanels = null;
                    this.updateSeamCount(newCount);
                });

                document.getElementById('mergeAll').addEventListener('click', () => {
                    this.saveState();
                    const newCount = Math.max(1, Math.floor((this.customPanels ? this.customPanels.length : this.seams) / 2));
                    this.customPanels = null;
                    this.updateSeamCount(newCount);
                });

                // Fixed reset panels functionality
                document.getElementById('resetPanels').addEventListener('click', () => {
                    this.saveState();
                    this.customPanels = null;
                    this.selectedIndex = null;
                    this.secondSelectedIndex = null;
                    this.calculate();
                });

                this.undoBtn.addEventListener('click', () => this.undo());
                
                // Fixed main reset button functionality
                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.saveState();
                    
                    // Reset all input values
                    this.seamsInput.value = 12;
                    this.sideSeamInput.value = 0.375;
                    this.lengthInput.value = 22;
                    this.waistInput.value = 38.5;
                    this.waistSeamInput.value = 0.375;
                    this.hemInput.value = 1.5;
                    
                    // Reset sliders and display values
                    ['seams','sideSeam','length','waist','waistSeam','hem'].forEach(id => {
                        const input = document.getElementById(id);
                        const slider = document.getElementById(id + 'Slider');
                        const val = document.getElementById(id + 'Value');
                        slider.value = input.value;
                        val.textContent = input.value;
                    });
                    
                    // Reset internal state
                    this.seams = 12;
                    this.customPanels = null;
                    this.selectedIndex = null;
                    this.secondSelectedIndex = null;
                    this.history = [];
                    this.setSkirtType('full');
                    
                    this.calculate();
                    this.updateUndoButton();
                });

                document.getElementById('previewBtn').addEventListener('click', () => {
                    this.generatePDF();
                });

                window.addEventListener('resize', () => {
                    this.initCanvas();
                    this.calculate();
                });
            }

            handleCanvasClick(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const waist = parseFloat(this.waistInput.value);
                const sideSeam = parseFloat(this.sideSeamInput.value);
                const length = parseFloat(this.lengthInput.value);
                const hem = parseFloat(this.hemInput.value);
                
                let multiplier;
                switch(this.skirtType) {
                    case 'full': multiplier = 2; break;
                    case 'three-quarter': multiplier = 1.5; break;
                    case 'half': multiplier = 1; break;
                    case 'third': multiplier = 0.666; break;
                    case 'quarter': multiplier = 0.5; break;
                }

                const adjustedWaist = waist + (sideSeam * 2);
                const waistRadius = adjustedWaist / (multiplier * Math.PI);
                const totalRadius = waistRadius + length + hem;
                
                // Apply rotation for bounds calculation
                let rotationAngle = 0;
                if (this.skirtType === 'half') {
                    rotationAngle = Math.PI / 4;
                } else if (this.skirtType === 'third') {
                    rotationAngle = Math.PI / 3;
                } else if (this.skirtType === 'quarter') {
                    rotationAngle = Math.PI / 4;
                }
                
                const bounds = this.getRotatedBounds(multiplier, waistRadius, totalRadius, rotationAngle);
                const padding = window.innerWidth <= 768 ? 10 : 20;
                const baseScale = Math.min((this.canvas.width - padding * 2) / bounds.width, (this.canvas.height - padding * 2) / bounds.height);
                const scale = window.innerWidth <= 768 ? baseScale * 1.1 : baseScale;
                const offsetX = (this.canvas.width / 2) - ((bounds.minX + bounds.maxX) / 2 * scale);
                const offsetY = (this.canvas.height / 2) - ((bounds.minY + bounds.maxY) / 2 * scale);

                const dx = x - offsetX;
                const dy = y - offsetY;
                const dist = Math.sqrt(dx * dx + dy * dy) / scale;
                let angle = Math.atan2(dy, dx);
                if (angle < 0) angle += Math.PI * 2;

                if (dist >= waistRadius && dist <= totalRadius) {
                    const clickedIndex = this.panels.findIndex(p => {
                        let start = p.startAngle % (Math.PI * 2);
                        let end = p.endAngle % (Math.PI * 2);
                        if (start > end) return angle >= start || angle <= end;
                        return angle >= start && angle <= end;
                    });

                    if (clickedIndex !== -1) {
                        if (this.selectedIndex === clickedIndex) {
                            this.selectedIndex = this.secondSelectedIndex;
                            this.secondSelectedIndex = null;
                        } else if (this.secondSelectedIndex === clickedIndex) {
                            this.secondSelectedIndex = null;
                        } else if (this.selectedIndex === null) {
                            this.selectedIndex = clickedIndex;
                        } else {
                            this.secondSelectedIndex = clickedIndex;
                        }
                        this.calculate();
                    }
                }
            }

            splitPanel(index) {
                if (!this.customPanels) {
                    this.generateInitialCustomPanels();
                }
                const panel = this.customPanels[index];
                const mid = (panel.start + panel.end) / 2;
                this.customPanels.splice(index, 1, 
                    { start: panel.start, end: mid },
                    { start: mid, end: panel.end }
                );
                this.selectedIndex = null;
                this.secondSelectedIndex = null;
                this.calculate();
            }

            mergePanels(idx1, idx2) {
                if (!this.customPanels) {
                    this.generateInitialCustomPanels();
                }
                const p1 = this.customPanels[idx1];
                const p2 = this.customPanels[idx2];
                
                const isAdjacent = Math.abs(p1.end - p2.start) < 0.001 || Math.abs(p2.end - p1.start) < 0.001;
                
                if (isAdjacent) {
                    const newPanel = {
                        start: Math.min(p1.start, p2.start),
                        end: Math.max(p1.end, p2.end)
                    };
                    const indices = [idx1, idx2].sort((a, b) => b - a);
                    this.customPanels.splice(indices[0], 1);
                    this.customPanels.splice(indices[1], 1);
                    this.customPanels.push(newPanel);
                    this.customPanels.sort((a, b) => a.start - b.start);
                    this.selectedIndex = null;
                    this.secondSelectedIndex = null;
                    this.calculate();
                }
            }

            generateInitialCustomPanels() {
                let multiplier;
                switch(this.skirtType) {
                    case 'full': multiplier = 2; break;
                    case 'three-quarter': multiplier = 1.5; break;
                    case 'half': multiplier = 1; break;
                    case 'third': multiplier = 0.666; break;
                    case 'quarter': multiplier = 0.5; break;
                }
                const panelSize = (multiplier * Math.PI) / this.seams;
                this.customPanels = [];
                for (let i = 0; i < this.seams; i++) {
                    this.customPanels.push({
                        start: i * panelSize,
                        end: (i + 1) * panelSize
                    });
                }
            }

            generatePDF() {
                const waist = parseFloat(this.waistInput.value);
                const sideSeam = parseFloat(this.sideSeamInput.value);
                const length = parseFloat(this.lengthInput.value);
                const hem = parseFloat(this.hemInput.value);
                const waistSeam = parseFloat(this.waistSeamInput.value);
                const seams = this.seams;

                let multiplier;
                switch(this.skirtType) {
                    case 'full': multiplier = 2; break;
                    case 'three-quarter': multiplier = 1.5; break;
                    case 'half': multiplier = 1; break;
                    case 'third': multiplier = 0.666; break;
                    case 'quarter': multiplier = 0.5; break;
                }

                const adjustedWaist = waist + (sideSeam * 2);
                const waistRadius = adjustedWaist / (multiplier * Math.PI);
                const totalRadius = waistRadius + length + hem;
                const totalHemArc = (totalRadius * multiplier * Math.PI);
                const waistArc = adjustedWaist + (waistSeam * 2);
                const panelAngle = (multiplier * Math.PI) / seams;
                const panelWaistArc = waistRadius * panelAngle;
                const panelHemArc = totalRadius * panelAngle;
                const sideSeamLength = totalRadius - waistRadius;

                // Create a new window with the PDF content
                const pdfWindow = window.open('', '_blank');
                pdfWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Circle Skirt Pattern</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            .pdf-header { text-align: center; margin-bottom: 30px; }
                            .pdf-header h1 { color: #2c3e50; }
                            .pdf-content { max-width: 800px; margin: 0 auto; }
                            .measurements-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            .measurements-table th, .measurements-table td { border: 1px solid #333; padding: 8px; text-align: center; }
                            .measurements-table th { background: #f0f0f0; }
                            .panel-measurements { margin: 30px 0; }
                            .instructions { margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
                            .instructions h3 { margin-top: 0; }
                            @media print { body { padding: 0; } }
                        </style>
                    </head>
                    <body>
                        <div class="pdf-content">
                            <div class="pdf-header">
                                <h1>Circle Skirt Pattern</h1>
                                <p>Generated on ${new Date().toLocaleDateString()}</p>
                            </div>
                            
                            <h2>Pattern Specifications</h2>
                            <table class="measurements-table">
                                <tr>
                                    <th>Parameter</th>
                                    <th>Value</th>
                                </tr>
                                <tr>
                                    <td>Skirt Type</td>
                                    <td>${this.skirtType.charAt(0).toUpperCase() + this.skirtType.slice(1)} Circle</td>
                                </tr>
                                <tr>
                                    <td>Waist Circumference</td>
                                    <td>${waist}"</td>
                                </tr>
                                <tr>
                                    <td>Skirt Length</td>
                                    <td>${length}"</td>
                                </tr>
                                <tr>
                                    <td>Number of Panels</td>
                                    <td>${seams}</td>
                                </tr>
                                <tr>
                                    <td>Waist Radius</td>
                                    <td>${waistRadius.toFixed(2)}"</td>
                                </tr>
                                <tr>
                                    <td>Total Radius</td>
                                    <td>${totalRadius.toFixed(2)}"</td>
                                </tr>
                                <tr>
                                    <td>Side Seam Allowance</td>
                                    <td>${sideSeam}"</td>
                                </tr>
                                <tr>
                                    <td>Waist Seam Allowance</td>
                                    <td>${waistSeam}"</td>
                                </tr>
                                <tr>
                                    <td>Hem Allowance</td>
                                    <td>${hem}"</td>
                                </tr>
                            </table>
                            
                            <div class="panel-measurements">
                                <h2>Panel Measurements (${seams} Panels Total)</h2>
                                <p><strong>Each Panel:</strong></p>
                                <ul>
                                    <li>Waist Arc: ${panelWaistArc.toFixed(2)}"</li>
                                    <li>Hem Arc: ${panelHemArc.toFixed(2)}"</li>
                                    <li>Side Seam Length: ${sideSeamLength.toFixed(2)}"</li>
                                </ul>
                                <p><strong>Total Measurements:</strong></p>
                                <ul>
                                    <li>Total Waist Arc: ${waistArc.toFixed(2)}"</li>
                                    <li>Total Hem Arc: ${totalHemArc.toFixed(2)}"</li>
                                </ul>
                            </div>
                            
                            <div class="instructions">
                                <h3>Instructions for Drafting:</h3>
                                <p>1. Draw a circle with radius: ${waistRadius.toFixed(2)}" (waist line)</p>
                                <p>2. Draw another circle with radius: ${totalRadius.toFixed(2)}" (hem line)</p>
                                <p>3. Divide the circle into ${seams} equal sections</p>
                                <p>4. Cut ${seams} panels using the measurements above</p>
                                <p>5. Add seam allowances as indicated by dotted lines on pattern</p>
                                <p>6. Sew panels together along side seams</p>
                                <p>7. Add waistband and hem according to seam allowances</p>
                            </div>
                        </div>
                    </body>
                    </html>
                `);
                pdfWindow.document.close();
                pdfWindow.print();
            }
        }

        const app = new CircleSkirtCalculator();
    </script>
</body>
</html>
